"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"jsonp",value:function(e,t){var o="jsonp_callback_"+Math.round(1e5*Math.random()),i=void 0;window[o]=function(e){delete window[o],document.body.removeChild(i),t(e)},i=document.createElement("script"),i.src=e+(e.indexOf("?")>=0?"&":"?")+"callback="+o,document.body.appendChild(i)}},{key:"toCapitalize",value:function(e){return e.length?e[0].toUpperCase()+e.slice(1):e}},{key:"getRandomInt",value:function(e,t){return Math.floor(Math.random()*(t-e))+e}}]),e}(),utils=new Utils,AudioContext=function(){function e(){_classCallCheck(this,e),this.audio=null}return _createClass(e,[{key:"setPlay",value:function(e){null!==this.audio&&this.setStop(),this.audio=new Audio(e.previewUrl),this.audio.id=e.trackId,this.audio.title=e.artistName+" — "+e.trackName,this.audio.volume=iPlayer.volume,this.audio.loop=!1,this.audio.autoplay=!0,this.audio.play(),this.audio.onloadedmetadata=this.loadedMetaData,this.audio.ontimeupdate=this.timeUpdate,this.audio.onended=this.onEnd,sessionStorage.setItem("currentId",this.audio.id)}},{key:"setStop",value:function(){null!==this.audio&&(this.audio.pause(),this.audio.currentTime=0)}},{key:"onEnd",value:function(e){this.autoplay&&iPlayer.api(null,"next",sessionStorage.getItem("song"))}},{key:"timeUpdate",value:function(){var e=document.querySelector(".timeline"),t=e.querySelector(".progress-bar"),o=this.duration,i=this.currentTime,n=100*i/o;n>100&&(n=100),e.classList.remove("hidden"),t.style.width=n+"%"}}]),e}(),audioContext=new AudioContext,Favourite=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"addToFavourite",value:function(){var e=document.querySelector(".favourites"),t=e.querySelector(".fav-list"),o=document.createElement("li"),i=document.createElement("a"),n=sessionStorage.getItem("currentId"),s=document.querySelector(".active-track .liked");t.querySelector('[data-id="'+n+'"]')||(i.setAttribute("href",audioContext.audio.src),i.setAttribute("class","favLink"),i.innerHTML=audioContext.audio.title,o.dataset.id=n,o.appendChild(i),t.appendChild(o),s.classList.add("selected"),sessionStorage.setItem("favId",(sessionStorage.getItem("favId")?sessionStorage.getItem("favId")+",":"")+audioContext.audio.id),sessionStorage.setObject("favObj",this.getSongById(n))),sessionStorage.getItem("favId")&&e.classList.remove("hidden")}},{key:"removeFromFavourite",value:function(){var e=document.querySelector(".favourites"),t=e.querySelector(".fav-list"),o=sessionStorage.getItem("currentId"),i=document.querySelector('[data-id="'+o+'"] .liked'),n=sessionStorage.getItem("favId").split(","),s=n.indexOf(o);t.removeChild(t.querySelector('[data-id="'+o+'"]')),n.splice(s,1),i.classList.remove("selected"),sessionStorage.setItem("favId",n.join()),sessionStorage.getItem("favId")&&sessionStorage.getItem("favId").length||e.classList.add("hidden")}},{key:"updateFavourites",value:function(e){var t=document.querySelector(".favourites"),o=t.querySelector(".fav-list"),i=document.createElement("li"),n=document.createElement("a");n.setAttribute("href",e.previewUrl),n.setAttribute("class","favLink"),n.innerHTML=e.artistName+" — "+e.trackName,i.dataset.id=e.trackId,i.appendChild(n),o.appendChild(i),this.updateFavouritesLikes(e)}},{key:"updateFavouritesLikes",value:function(e){document.querySelector('[data-id="'+e.trackId+'"] .liked')&&document.querySelector('[data-id="'+e.trackId+'"] .liked').classList.add("selected")}},{key:"highlightFavourite",value:function(e){[].forEach.call(document.querySelectorAll(".favourites [data-id]"),function(e){e.classList.remove("active")}),document.querySelector('[data-id="'+ +e+'"]').classList.add("active")}}]),e}(),fav=new Favourite,IPlayer=function(){function e(t){_classCallCheck(this,e),"undefined"!==window.webkitSpeechRecognition&&(this.options=t||{},this.patience=this.options.patience||3,this.limit=this.options.limit||50,this.volume=this.options.volume||1,this.volumeWhenSpeak=this.options.volumeWhenSpeak||.1,this.loadingCopy=this.options.loading||"Loading…",this.speechNotification=this.options.speechNotification||"alert",this.langs=[["English",["en-GB"]],["Pусский",["ru-RU"]]],this.commands={play:["play","find","search","найти"],next:["next","дальше","вперед"],previous:["previous","назад","предыдущий"],repeat:["repeat","повторить"],loop:["loop","зациклить"],autoplay:["autoplay","автовоспроизведение"],stop:["stop","стоп"],random:["random","произвольно"],volume:["volume","сделать"],mute:["mute","беззвучный"],like:["like","нравится","класс"],dislike:["dislike","плохо","ерунда"],go:["go","перейти"]},this.songs=[],this.index=0,this.recognition=new window.webkitSpeechRecognition,this.recognition.continuous=!0,this.timeout=null,this.recognizing=!1,this.utterance=new window.SpeechSynthesisUtterance,this.utterance.rate=1,this.utterance.pitch=1,this.utterance.volume=1,this.loadingElement=document.querySelector(".loading"),"function"==typeof this.init&&"undefined"!==this.init&&this.init())}return _createClass(e,[{key:"init",value:function(){function e(){console.log("onstart"),r.recognizing=!0,s(),null!==audioContext.audio&&(audioContext.audio.volume=r.volumeWhenSpeak)}function t(){r.recognizing=!1,clearTimeout(r.timeout)}function o(e){console.log(e.error)}function i(){var e=event.results[0][0].transcript,t=e.split(" ").splice(0,1).join(" ").toLowerCase(),o=e.split(" ").splice(1).join(" ");s(),n(t,o)}function n(e,t){-1!==r.commands.play.indexOf(e)?(r.refresh(),r.loader("remove"),utils.jsonp("https://itunes.apple.com/search?term="+t+"&limit="+r.options.limit,function(o){r.api(o,e,t)})):r.api(null,e,t)}function s(){clearTimeout(r.timeout),r.timeout=setTimeout(function(){r.recognition.stop()},1e3*r.patience)}function a(e){var t=e.target,o=t.parentElement,i=void 0,n=void 0;if("playerBtn"===t.getAttribute("id")){if(e.preventDefault(),r.recognizing)return void r.recognition.stop();r.recognition.start()}o.classList.contains("trackLink")&&(e.preventDefault(),i=+t.closest("[data-index]").dataset.index,audioContext.setPlay(r.songs[i]),r.index=i,i+=1,sessionStorage.setItem("index",r.index),r.highlight(+sessionStorage.getItem("index"))),t.classList.contains("favLink")&&(e.preventDefault(),n=+t.closest("[data-id]").dataset.id,fav.highlightFavourite(n),utils.jsonp("https://itunes.apple.com/lookup?id="+n,function(e){audioContext.setPlay(e.results[0]),document.querySelector('.tune-wrap [data-id="'+e.results[0].trackId+'"]')&&(sessionStorage.setItem("index",document.querySelector('.tune-wrap [data-id="'+e.results[0].trackId+'"]').closest("[data-index]").dataset.index),r.highlight(+sessionStorage.getItem("index")))}))}var r=this,u=document.getElementById("main");this.language(),this.sessions(),this.favourites(),this.recognition.onstart=e,this.recognition.onend=t,this.recognition.onerror=o,this.recognition.onresult=i,u.onclick=a}},{key:"api",value:function(e,t,o){var i=document.querySelector(".tune-wrap"),n=document.getElementById("search-query"),s=document.getElementById("search-total"),a="stop"===sessionStorage.getItem("action")?"stop":"play",r=sessionStorage.getItem("favId"),u=void 0,l=void 0,d=void 0,c=void 0,h=void 0;for(var m in this.commands)this.commands.hasOwnProperty(m)&&-1!==this.commands[m].indexOf(t)&&(t=m);switch(sessionStorage.setItem("action",t),console.log(t),t){case"play":if(u=e.results,"object"!==_typeof(u[0])||"undefined"===u[0])return void this.speechAlert("Oops, for your searching nothing found! Try again.");for(;i.firstChild;)i.removeChild(i.firstChild);this.loader("add");for(l in u)null!==u[l]&&u.hasOwnProperty(l)&&(this.songs.push(u[l]),this.thumbnail(u[l],l));n.parentElement.classList.remove("hidden"),n.innerHTML=utils.toCapitalize(o),s.innerHTML=e.resultCount,sessionStorage.setItem("song",o),"play"===a&&audioContext.setPlay(this.songs[+sessionStorage.getItem("index")]),r&&utils.jsonp("https://itunes.apple.com/lookup?id="+r,function(e){for(var t=0;t<e.results.length;t+=1)fav.updateFavouritesLikes(e.results[t])});break;case"repeat":audioContext.setPlay(this.songs[+sessionStorage.getItem("index")]);break;case"autoplay":audioContext.audio.autoplay=audioContext.audio.autoplay!==!0,audioContext.audio.volume=this.volume;break;case"loop":audioContext.audio.loop=audioContext.audio.loop!==!0,audioContext.audio.volume=this.volume;break;case"next":+sessionStorage.getItem("index")>this.songs.length-2&&sessionStorage.setItem("index",-1),sessionStorage.setItem("index",+sessionStorage.getItem("index")+1),audioContext.setPlay(this.songs[+sessionStorage.getItem("index")]);break;case"random":var g=utils.getRandomInt(0,this.limit);sessionStorage.setItem("index",+g),audioContext.setPlay(this.songs[+sessionStorage.getItem("index")]);case"previous":0===+sessionStorage.getItem("index")&&+sessionStorage.setItem("index",this.songs.length),+sessionStorage.setItem("index",+sessionStorage.getItem("index")-1),audioContext.setPlay(this.songs[+sessionStorage.getItem("index")]);break;case"stop":audioContext.setStop();break;case"volume":"up"===o||"громче"===o?this.volume<1&&(this.volume+=.2):"down"!==o&&"тише"!==o||this.volume>0&&(this.volume-=.2),audioContext.audio.volume=this.volume;break;case"mute":audioContext.audio.muted=audioContext.audio.muted!==!0;break;case"like":fav.addToFavourite(),audioContext.audio.volume=this.volume;break;case"dislike":fav.removeFromFavourite(),audioContext.audio.volume=this.volume;break;case"go":d=document.querySelector(".active-track"),c=d.querySelector(".trackArtist").getAttribute("href"),h=d.querySelector(".trackCollection").getAttribute("href"),"to artist"===o||"автор"===o?window.open(c,"_blank"):"to collection"!==o&&"коллекция"!==o||window.open(h,"_blank"),audioContext.audio.volume=this.volume;break;default:this.loader("add"),this.speechAlert("Unknown command. Try again.")}this.highlight(+sessionStorage.getItem("index"))}},{key:"highlight",value:function(e){[].forEach.call(document.querySelectorAll("[data-index]"),function(e){e.classList.remove("active-track")}),document.querySelector('[data-index="'+ +e+'"]').classList.add("active-track")}},{key:"getSongById",value:function(e){for(var t in this.songs){if(!this.songs.hasOwnProperty(t))return;if(this.songs[t].trackId===+e)return this.songs[t]}}},{key:"language",value:function(){for(var e=this,t=0;t<this.langs.length;t+=1)selectLanguage.options[t]=new Option(this.langs[t][0],this.langs[t][1]);selectLanguage.onchange=function(){e.recognition.lang=selectLanguage.value},this.recognition.lang=selectLanguage.value}},{key:"refresh",value:function(){this.songs=[],this.index=0,sessionStorage.setItem("index",0)}},{key:"loader",value:function(e){this.loadingElement.innerHTML=this.loadingCopy,"add"===e?this.loadingElement.classList.add("hidden"):"remove"===e&&this.loadingElement.classList.remove("hidden")}},{key:"sessions",value:function(){var e=this,t=sessionStorage.getItem("song"),o=sessionStorage.getItem("favId");t&&(this.loader("remove"),utils.jsonp("https://itunes.apple.com/search?term="+t+"&limit="+this.options.limit,function(i){e.api(i,"play",t),o&&utils.jsonp("https://itunes.apple.com/lookup?id="+o,function(e){for(var t=0;t<e.results.length;t+=1)fav.updateFavourites(e.results[t])})}))}},{key:"speechAlert",value:function(e){var t=this;"speech"===this.speechNotification?(this.utterance.text=e,this.utterance.onend=function(e){null!==audioContext.audio&&(audioContext.audio.volume=t.volume)},speechSynthesis.speak(this.utterance)):"alert"===this.speechNotification&&(alert(e),null!==audioContext.audio&&(audioContext.audio.volume=this.volume))}},{key:"thumbnail",value:function t(e,o){var i=document.getElementById("thumbnail").content,n=document.querySelector(".tune-wrap"),t=i.querySelector(".thumbnail"),s=t.querySelector(".caption"),a=s.querySelector(".trackImg"),r=s.querySelector(".trackLink"),u=s.querySelector("h5"),l=s.querySelector(".trackGenre"),d=s.querySelector(".trackCountry"),c=s.querySelector(".trackArtist"),h=s.querySelector(".trackCollection");t.dataset.id=e.trackId,a.src=e.artworkUrl100,a.alt=e.collectionCensoredName||"",u.textContent=e.artistName+" — "+e.trackName,r.href=e.previewUrl,l.textContent=e.primaryGenreName,d.textContent=e.country,c.href=e.artistViewUrl,h.href=e.collectionViewUrl,i.children[0].setAttribute("data-index",o),n.appendChild(document.importNode(i,!0))}},{key:"favourites",value:function(e,t){var o=document.getElementById("favourites").content,i=document.querySelector(".favourites");i.appendChild(document.importNode(o,!0)),sessionStorage.getItem("favId")?i.classList.remove("hidden"):i.classList.add("hidden")}}]),e}();